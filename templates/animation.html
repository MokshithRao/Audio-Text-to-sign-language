{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="split left">
	<h2 align="center">Enter Text or Use Mic</h2>
	<br>
	<form id="textForm" action="" method="post" align="left">
		{% csrf_token %}
		<input type="text" name="sen" class="mytext" id="speechToText" placeholder="">
		<button type="button" name="button" class="mic" onclick="record()"><img src="{% static 'mic3.png' %}" height="32px" width="38px" /></button>
		&nbsp&nbsp&nbsp&nbsp
		<input type="submit" name="submit" class="submit">
	</form>
	<br>
	<table cellspacing="20px">
		<tr>
			<td class="td">The text that you entered is:</td>
			<td class="td" id="enteredText">{{ text }}</td>
		</tr>
		<tr>
			<td class="td">Key words in sentence:</td>
			<td class="td">
			<ul class="td" id="list" align="center">
				{% for word in words %}
				<li id="{{ forloop.counter0 }}" style="margin-right: 8px">{{ word }}</li>
				{% endfor %}
			</ul>
		</td>
		</tr>
	</table>
</div>
<div class="split right">
<h2 align="center">Sign Language Animation</h2>
	<div style="text-align:center">
	<button class="submit" onclick="playPause()" style="margin-top: 23px;">Play/Pause</button>
	<br><br>
	<video id="videoPlayer" width="600" height="350"  preload="auto" autoplay style="margin-top: 10px;">
		<source src="" type="video/mp4">
	Your browser does not support HTML5 video.
	</video>
	</div>
</div>

<script>
// webkitSpeechRecognition api for speech to text conversion
function record(){
	var recognition = new webkitSpeechRecognition();
	recognition.lang='en-IN';
	recognition.onresult = function(event){
		document.getElementById('speechToText').value = event.results[0][0].transcript;
	}
	recognition.start();
}

// AJAX form submission for live preview
const form = document.getElementById('textForm');
form.addEventListener('submit', function(e) {
	e.preventDefault();
	const text = document.getElementById('speechToText').value;
	const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
	fetch(window.location.pathname, {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
			'X-CSRFToken': csrfToken,
			'X-Requested-With': 'XMLHttpRequest'
		},
		body: JSON.stringify({sen: text})
	})
	.then(response => response.json())
	.then(data => {
		// Update entered text
		document.getElementById('enteredText').textContent = data.text;
		// Update keywords list
		const list = document.getElementById('list');
		list.innerHTML = '';
		data.words.forEach((word, i) => {
			const li = document.createElement('li');
			li.id = i;
			li.style.marginRight = '8px';
			li.textContent = word;
			list.appendChild(li);
		});
		// Optionally, auto-play animation
		if (data.words.length > 0) {
			play();
		}
	});
});

function play() {
	var videoSource = [];
	var videos = document.getElementById("list").getElementsByTagName("li");
	for(var j=0;j<videos.length;j++) {
		videoSource[j] = "/static/" + videos[j].innerHTML + ".mp4";
	}
	var i = 0;
	var videoCount = videoSource.length;
	function videoPlay(videoNum) {
		document.getElementById("list").getElementsByTagName("li")[videoNum].style.color = "#09edc7";
		document.getElementById("list").getElementsByTagName("li")[videoNum].style.fontSize = "xx-large";
		document.getElementById("videoPlayer").setAttribute("src", videoSource[videoNum]);
		document.getElementById("videoPlayer").load();
		document.getElementById("videoPlayer").play();
	}
	document.getElementById('videoPlayer').onended = myHandler;
	if (videoCount > 0) {
		document.getElementById("list").getElementsByTagName("li")[0].style.color = "#09edc7";
		document.getElementById("list").getElementsByTagName("li")[0].style.fontSize = "xx-large";
		videoPlay(0);
	}
	function myHandler() {
		document.getElementById("list").getElementsByTagName("li")[i].style.color = "#feda6a";
		document.getElementById("list").getElementsByTagName("li")[i].style.fontSize = "20px";
		i++;
		if (i == videoCount) {
			document.getElementById("videoPlayer").pause();
		} else {
			videoPlay(i);
		}
	}
}
function playPause(){
	if (document.getElementById("videoPlayer").paused){
		play();
	} else {
		document.getElementById("videoPlayer").pause();
	}
}
</script>

{% endblock %}
